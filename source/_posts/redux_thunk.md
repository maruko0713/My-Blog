---
title: ä»redux-thunkçš„14è¡Œæºç å’Œdispatchå‡½æ•°çš„å®ç°è¿‡ç¨‹ï¼Œè¯´è¯´æˆ‘çœ¼ä¸­çš„reduxä¸­é—´ä»¶
date: 2018-01-04
tags: ["redux","middleware"]
---
## ç¼˜èµ·
æˆ‘æ˜¯åœ¨å»å¹´æš‘å‡ç¬¬ä¸€æ¬¡æœ‰äº†â€œè¯¥ç”¨reduxä»£æ›¿çƒ¦æ­»äººçš„propsä¼ é€’äº†â€çš„æ¦‚å¿µåï¼Œåœ¨githubä¸Šæ‰’æ‹‰åˆ«äººçš„reduxé¡¹ç›®çœ‹ï¼Œç„¶åç¬¬ä¸€æ¬¡è§åˆ°thunkè¿™ä¸ªä¸­é—´ä»¶ã€‚åæ¥ä¸€å›¾é‡æ„ï¼Œæˆ‘è®°å¾—æˆ‘ä»¬çš„reduxé‡Œæ˜¯ç”¨äº†è¿™ä¸ªä¸­é—´ä»¶ã€‚é€‰ç”¨çš„å¥‘æœºæ˜¯ï¼Œæ–‡æ¡£å’Œåˆ«äººçš„å¼€æºé¡¹ç›®å‘Šè¯‰æˆ‘ä»¬ï¼Œå®ƒæœ‰ç”¨ã€‚ã€‚ã€‚ã€‚         
ç„¶åæœ€è¿‘æ€»æ˜¯é‡åˆ°ä¸€ä¸ªç›¸åŒçš„é—®é¢˜ï¼šå¦‚æœæˆ‘æœ‰ä¸€ä¸ªå¼‚æ­¥è¯·æ±‚ï¼Œéœ€è¦æŠŠè¯·æ±‚å›æ¥çš„æ•°æ®ç»™æ”¾è¿›storeé‡Œï¼Œæˆ‘è¯¥å’‹åŠï¼Ÿï¼Ÿï¼Ÿ    
å—¨å‘€ï¼Œæ—¢ç„¶æˆ‘éƒ½è¿™ä¹ˆå†™äº†ï¼Œè‚¯å®šæ˜¯ç”¨thunkä¸­é—´ä»¶å‘€ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ğŸ˜‚    

## Reduxä¸­é—´ä»¶
æœ¬æ¥æƒ³è´´ä¸ªå®šä¹‰ï¼Œç»“æœæŸ¥å®Œç™¾ç§‘ä¸Šçš„å®šä¹‰ï¼Œæˆ‘æ„Ÿè§‰æˆ‘å¯èƒ½ç”¨çš„éƒ½æ˜¯å‡çš„ä¸­é—´ä»¶ã€‚ã€‚ã€‚æ‰€ä»¥è¿™é‡Œå°±è¯´è¯´æˆ‘è‡ªå·±çš„ç†è§£å§ã€‚      
ä¸­é—´ä»¶æˆ‘ä¸€èˆ¬æ˜¯åœ¨åç«¯é‡Œç”¨çš„æ¯”è¾ƒå¤šï¼Œæ¯”å¦‚expressæ¡†æ¶ï¼Œdjangoæ¡†æ¶é‡Œçš„ä¸­é—´ä»¶ã€‚â€œä¸­é—´â€ï¼Œæˆ‘çš„ç†è§£æ˜¯ï¼Œä»æœåŠ¡å™¨æ¥æ”¶åˆ°requestï¼Œåˆ°è·¯ç”±å¼€å§‹å¤„ç†requestè¿™ä¸­é—´çš„â€œä¸­é—´â€ã€‚     
å†è¯´è¯´è¿™ä¸ªreduxä¸­é—´ä»¶å§ï¼Œç±»æ¯”æ¥ç†è§£ï¼Œé‡ç‚¹è¯´è¯´â€œä¸­é—´â€ã€‚è¿™é‡Œçš„â€œä¸­é—´â€ï¼ŒæŒ‡çš„æ˜¯ä»reduxçš„actionæ´¾å‘å¼€å§‹ï¼Œåˆ°åˆ°è¾¾reducerä¹‹å‰çš„è¿™æ®µæ—¶æœºã€‚    
   
### ä¸ºä»€ä¹ˆéœ€è¦Reduxä¸­é—´ä»¶    
åœ¨redux-thunkçš„æ–‡æ¡£é‡Œï¼Œç»™äº†æˆ‘ä»¬ä¸€ä¸ªstackoverflowçš„é“¾æ¥ï¼Œè¯•å›¾å‘æˆ‘ä»¬è§£é‡Šï¼Œä¸ºå•¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨è¿™ç©æ„ã€‚å…¶ä¸­æœ‰ä¸€ä¸ªå›ç­”å¼€å¤´è¿™æ ·è¯´é“ï¼šâ€œDonâ€™t fall into the trap of thinking a library should prescribe how to do everything.â€ã€‚
**ç¿»è¯‘è¿‡æ¥å°±æ˜¯ï¼Œä¸è¦è®¤ä¸ºè¯´ä¸€ä¸ªåº“ï¼ˆreduxï¼‰å¯ä»¥å¸®æˆ‘ä»¬åšä»»ä½•äº‹**     
è¯´å¾—å†ç›´æ¥ä¸€ç‚¹ï¼Œreduxè¿˜ä¸å¤Ÿå¼ºï¼Œå¹¶ä¸èƒ½æ»¡è¶³æ‰€æœ‰çš„å¼€å‘æƒ…å¢ƒï¼Œè¦å¸¦ä¸Šå®ƒçš„ä¸­é—´ä»¶ï¼Œå®ƒæ‰å¤Ÿå¼ºã€‚   

    
## åˆè¯†ï¼š14è¡Œæºä»£ç 
**Thunkä¸­é—´ä»¶å¯ä»¥å¸®æˆ‘ä»¬åšä»€ä¹ˆ**
å›åˆ°æ­£é¢˜ï¼ŒThunkä¸­é—´ä»¶åšäº†ä»€ä¹ˆï¼Œæˆ‘ä»¬å¾—ä»å®ƒçš„æºä»£ç è¯´èµ·ï¼š  
ï¼ˆä¹‹æ‰€ä»¥ä¸€ç›´è¯´14è¡Œ æ˜¯å› ä¸ºæˆ‘ç¬¬ä¸€æ¬¡çœ‹åˆ°çš„æ—¶å€™ï¼Œè¢«è¿™æ®µæºä»£ç æƒŠåˆ°äº†ã€‚ã€‚ã€‚ä¸ä»…çŸ­ï¼Œè€Œä¸”å®¹æ˜“æ‡‚ï¼Œçœ‹å®Œå½»åº•ä¸æŠ“çäº†ï¼Œç‰¹åˆ«å¼€å¿ƒï¼‰    
    
```js
function createThunkMiddleware(extraArgument) {
  return ({ dispatch, getState }) => next => action => {
    if (typeof action === 'function') {
      return action(dispatch, getState, extraArgument);
    }

    return next(action);
  };
}

const thunk = createThunkMiddleware();
thunk.withExtraArgument = createThunkMiddleware;

export default thunk;
```

<!-- more --> 
æˆ‘æ¥è§£é‡Šä¸€ä¸‹è¿™æ®µä»£ç ï¼ˆè™½ç„¶å¯èƒ½å¹¶ä¸éœ€è¦æˆ‘è§£é‡Šã€‚ã€‚ã€‚ã€‚/æ‚è„¸ï¼‰
é¦–å…ˆï¼Œthunkä¸­é—´ä»¶æŠ“ä½äº†æˆ‘ä»¬æ´¾å‘çš„actionå¯¹è±¡ï¼Œç„¶åç»™å®ƒè£¹ä¸€å±‚ï¼Œåœ¨å®ƒçš„å¤–å±‚ï¼ŒæŠŠdispatchå’ŒgetStateæ–¹æ³•ä¼ è¿›æ¥äº†ã€‚éšåï¼Œå¯¹actionçš„ç§ç±»è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœactionæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œé‚£ä¹ˆå°±æŠŠdispatchå’ŒgetStateéƒ½ä¼ è¿›å»ï¼Œç„¶åæ‰§è¡Œè¿™ä¸ªå‡½æ•°ã€‚     

    
ç„¶åè¯´è¯´è¿™æ®µä»£ç çš„ç”¨æ„å§ã€‚å®ƒå¸Œæœ›æˆ‘ä»¬æŠŠactionå†™æˆä¸€ä¸ªå‡½æ•°ï¼Œäºæ˜¯å®ƒå°±å¯ä»¥åˆ©ç”¨è£¹ä¸€å±‚è¿™ç§æ–¹å¼æŠŠdispatchå’ŒgetStateç»™ä¼ è¿›å»äº†ï¼Œäºæ˜¯æˆ‘ä»¬å°±å¯ä»¥åœ¨actioné‡Œæ´¾å‘å¯¹è±¡å’ŒæŸ¥çœ‹stateçŠ¶æ€äº†ï¼Œäºæ˜¯actionä»ä¸€ä¸ªæ‰‹æ— ç¼šé¸¡ä¹‹åŠ›çš„å¯¹è±¡ï¼Œå˜æˆäº†ä¸€ä¸ªå¯ä»¥æ“ä½œstateæ ‘çš„å‡½æ•°~      
    
æ‰€ä»¥Thunkçš„ç›®çš„å°±æ˜¯ï¼Œå¸®åŠ©æˆ‘ä»¬æŠŠactionå˜æˆå‡½æ•°ï¼Œä»è€ŒæŠŠdispatchæ”¾åœ¨actionè¿™ä¸€æ­¥ã€‚æˆ‘ä»¬å¯ä»¥æ³¨æ„åˆ°ï¼ŒThunkä¸­é—´ä»¶æœ€åç›´æ¥returnäº†actionçš„ç»“æœï¼Œæ ¹æœ¬æ²¡æŠŠactionå¾€reduceré‚£é‡Œå‘é€äº†ã€‚åœ¨actionæ˜¯functionçš„æƒ…å†µä¸‹ï¼Œreduceråªèƒ½åœ¨ä¸€è¾¹è‡ªå·±ç©ã€‚     
    
è¯´å¾—å†æ¸…æ¥šä¸€ç‚¹ï¼ŒThunkæŠŠreducerè¸¹å¼€äº†ï¼Œäºæ˜¯æˆ‘ä»¬åœ¨actionå‡½æ•°é‡Œä¸ºæ‰€æ¬²ä¸ºï¼ˆä¹Ÿå°±æ˜¯å¯ä»¥å®ç°å¼‚æ­¥æ“ä½œï¼‰ã€‚    
   
## æ›´è¿›ä¸€æ­¥ï¼šä¸ºå•¥è¿™æ ·åšï¼ˆç†è§£dispatchå‡½æ•°åˆ°åº•åšäº†ä»€ä¹ˆï¼‰
è¯»å®ŒThunkçš„æºä»£ç ï¼Œæˆ‘åªæƒ³é—®ï¼šä¸ºå•¥è¦æŠŠreduceræ¶ç©ºï¼Ÿreduceråšé”™äº†ä»€ä¹ˆï¼Ÿï¼Ÿï¼Ÿï¼Ÿ      
å¯¹å‘€ï¼Œå› ä¸ºæˆ‘ä»¬ä»¥å¾€çš„stateæ›´æ–°æ“ä½œï¼Œæ˜¯åœ¨reduceré‡Œè®¡ç®—è¿”å›çš„ã€‚      
ç®€å•åœ°ç†è§£çš„è¯ï¼Œé—®é¢˜æ˜¯åœ¨äºï¼Œreducerè¿™ä¸ªä¸œè¥¿ï¼Œè§„çŸ©æ¯”è¾ƒå¤šï¼Œå®ƒæ˜¯ä¸€ä¸ªçº¯å‡½æ•°ï¼Œåªå…è®¸æˆ‘ä»¬åœ¨é‡Œé¢è®¡ç®—ï¼Œstateéƒ½ä¸è®©ä½ æ”¹ï¼Œä½ è¿˜æƒ³å‘å¼‚æ­¥è¯·æ±‚ï¼Ÿï¼Ÿï¼Ÿï¼Ÿnaiveï¼/å¾®ç¬‘       
    
é€€ä¸€ä¸‡æ­¥è¯´ï¼Œå°±ç®—æ²¡æœ‰è¿™ä¸ªè§„å®šäº†ï¼Œä½ åœ¨reduceré‡Œå‘é€ä¸ªè¯·æ±‚è¯•è¯•ï¼Ÿè¦æ˜¯èƒ½æ‹¿åˆ°æ•°æ®ï¼ŒThunkä¸­é—´ä»¶åŸåœ°åƒç¿”å¥½ä¸å¥½ï¼Ÿï¼Ÿï¼Ÿ     
ä¸ºå•¥è¿™ä¹ˆè¯´ï¼Œæ˜¯å› ä¸ºreduceræ˜¯ä¸€ä¸ªåŒæ­¥çš„å‡½æ•°ã€‚è¦æ˜¯è¿˜ä¸æ¸…æ¥šï¼ˆå½“åˆæˆ‘å°±æ²¡æ¸…æ¥šï¼‰ï¼Œå°±å¾—çœ‹çœ‹reduxæºä»£ç é‡Œå¯¹reducerçš„ä¸€ä¸ªå¤„ç†äº†ï¼Œè¿™é‡Œæˆ‘ä»¬è´´ä¸€ä¸‹dispatchå‡½æ•°çš„æºç ï¼š    
    
```js
  function dispatch(action) {
    if (!isPlainObject(action)) {
      throw new Error(
        'Actions must be plain objects. ' +
          'Use custom middleware for async actions.'
      )
    }

    if (typeof action.type === 'undefined') {
      throw new Error(
        'Actions may not have an undefined "type" property. ' +
          'Have you misspelled a constant?'
      )
    }

    if (isDispatching) {
      throw new Error('Reducers may not dispatch actions.')
    }

    try {
      isDispatching = true
      currentState = currentReducer(currentState, action)
    } finally {
      isDispatching = false
    }

    const listeners = (currentListeners = nextListeners)
    for (let i = 0; i < listeners.length; i++) {
      const listener = listeners[i]
      listener()
    }

    return action
  }
  ```

  ä¸ºäº†çªå‡ºé‡ç‚¹ï¼Œå…¶å®å¯ä»¥åªçœ‹è¿™ä¸€æ®µï¼š      

```js
try {
  isDispatching = true
  currentState = currentReducer(currentState, action)
} finally {
  isDispatching = false
}
```
    
æˆ–è€…åªçœ‹è¿™ä¸€å¥ï¼š      
    
```js
currentState = currentReducer(currentState, action)
```

æ˜¯çš„ï¼Œæ­»å¿ƒå§ï¼ŒcurrentStateè¦çš„æ˜¯currentReducerçš„åŒæ­¥çš„è¿”å›å€¼ã€‚reduceråªèƒ½æ˜¯ä¸ªåŒæ­¥çš„ï¼Œä¸å¯èƒ½async/await(è¿™æ ·currentReducerè¿™ä½å“¥å°±æ˜¯ä¸€ä¸ªasyncå‡½æ•°äº†ï¼Œå®ƒè°ƒç”¨æ—¶å‰é¢å¿…é¡»æœ‰ä¸ªawaitï¼Œç„¶è€Œæ²¡æœ‰ï¼‰ï¼Œä¹Ÿä¸å¯èƒ½Generator/yieldï¼ˆé‚£æ ·è¿”å›çš„å°±æ˜¯ä¸€ä¸ªç”Ÿæˆå™¨å¯¹è±¡ï¼Œä¸æ˜¯currentStateæƒ³è¦çš„ï¼Œå°±æ›´ç¦»è°±äº†ï¼Œå¯æ‹‰å€’å§ï¼‰ã€‚        
     
ç»¼ä¸Šæ‰€è¿°ï¼Œreduceråªèƒ½æ˜¯ä¸€ä¸ªåŒæ­¥çš„ä¸œè¥¿ï¼Œå³åˆ»è¿”å›ï¼Œä¸ä¼šç­‰ä»»ä½•äººã€‚  
    
è€Œä½¿ç”¨Thunkæä¾›ç»™æˆ‘ä»¬çš„æ–¹æ¡ˆï¼Œactionå˜æˆå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°éšä¾¿ä½ æ€ä¹ˆæŠ˜è…¾æ€ä¹ˆè°ƒç”¨ï¼Œå¼‚æ­¥ä¸åœ¨è¯ä¸‹ï¼Œæ­ªç‘okå‘€~~~ï¼   

     
## åè®°
æ˜¯çš„ï¼Œ**å› ä¸ºreducerä¸èƒ½å¸®æˆ‘ä»¬åšå¤ªå¤š**ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦ç”¨ä¸­é—´ä»¶ã€‚   
è¿™æ˜¯Thunkä¸­é—´ä»¶æ‰€æ•™ä¼šæˆ‘çš„ï¼Œreduxä¸­ä¸­é—´ä»¶çš„æ„ä¹‰ã€‚ç¿»é˜…[reduxæ–‡æ¡£çš„ä¸­é—´ä»¶éƒ¨åˆ†](http://www.redux.org.cn/docs/advanced/Middleware.html)ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸­é—´ä»¶çš„ä½œç”¨ï¼Œä¸ä»…ä»…æ˜¯å°è£…dispatchè¿™ä¹ˆç®€å•ã€‚è¿™ç¯‡æ–‡ç« ï¼Œä¹Ÿåªæ˜¯é’ˆå¯¹å®é™…çš„éœ€è¦ï¼Œè°ˆè°ˆè‡ªå·±çš„ä½“ä¼š~    

ä¸­é—´ä»¶å¯ä»¥è®¤ä¸ºæ˜¯reduxåŠŸèƒ½ä¸Šçš„ä¸€ä¸ªè¡¥å……ã€‚æœ‰äº†å®ƒï¼Œreduxçš„åŠŸèƒ½æ›´åŠ å®Œæ•´ï¼Œä¹Ÿæ›´èƒ½é€‚åº”æˆ‘ä»¬å®é™…å¼€å‘çš„éœ€è¦~è‚¥è‚ çš„æ£’ï¼    









